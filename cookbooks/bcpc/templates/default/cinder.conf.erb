################################################
#
#              Generated by Chef
#
################################################

[DEFAULT]
# XXX: The following is a work-around to allow any cinder process
#      to serve any volume (since they're RBD backed)
host = bcpc
storage_availability_zone=
allow_availability_zone_fallback=<%= node['bcpc']['cinder']['allow_az_fallback'] %>
rootwrap_config = /etc/cinder/rootwrap.conf
api_paste_confg = /etc/cinder/api-paste.ini
verbose = <%= node['bcpc']['cinder']['verbose'] %>
debug = <%= node['bcpc']['cinder']['debug'] %>
auth_strategy = keystone
state_path = /var/lib/cinder
logdir=/var/log/cinder
# v1 API is being removed in Liberty
enable_v1_api=<%= is_kilo? %>
enable_v2_api=true

# Bind to mgt IP only
osapi_volume_listen=<%=node['bcpc']['management']['ip']%>
osapi_volume_workers=<%= node['bcpc']['cinder']['workers'] %>

# If using qpid...
#rpc_backend=cinder.openstack.common.rpc.impl_qpid
#qpid_hostname=<%=node['bcpc']['management']['vip']%>
#qpid_username=admin
#qpid_password=<%=get_config('rabbitmq-password')%>

# Other service endpoints
glance_api_servers=<%=node['bcpc']['protocol']['glance']%>://openstack.<%=node['bcpc']['cluster_domain']%>:9292
glance_api_insecure=True
glance_api_version=2

# Volume driver settings for RBD
enabled_backends=<%= node['bcpc']['ceph']['enabled_pools'].map {|type| type.upcase}.join(",") %>

# Ceilometer metrics
#control_exchange = cinder
#notification_driver = cinder.openstack.common.notifier.rpc_notifier

<%# default quotas in Liberty are set exclusively with cinder quota-class-update %>
<% if is_kilo? %>
# Quotas
<% node['bcpc']['cinder']['quota'].each do | key, value| %>
quota_<%=key%> = <%= value %>
<% end %>
<% end %>

[oslo_messaging_rabbit]
# Rabbit message queue settings
#rabbit_host=<%=node['bcpc']['management']['vip']%>
rabbit_hosts=<%=get_shuffled_servers(@servers, prefer_local=true).map{|x| x['bcpc']['management']['ip'] + ":5672"}.join(',')%>
rabbit_password=<%=get_config('rabbitmq-password')%>
rabbit_ha_queues=True
heartbeat_timeout_threshold=<%=node['bcpc']['rabbitmq']['heartbeat']%>
amqp_durable_queues=<%=node['bcpc']['rabbitmq']['durable_queues']%>

[oslo_concurrency]
lock_path=/var/lock/cinder

[database]
# MySQL Connection
connection=mysql://<%=get_config('mysql-cinder-user')%>:<%=get_config('mysql-cinder-password')%>@<%=node['bcpc']['management']['vip']%>/<%=node['bcpc']['dbname']['cinder']%>
idle_timeout=3600

[ssl]
# ca_file = /etc/ssl/certs/ssl-bcpc.pem

[keystone_authtoken]
# cafile = /etc/ssl/certs/ssl-bcpc.pem
auth_uri = <%=node['bcpc']['protocol']['keystone']%>://openstack.<%=node['bcpc']['cluster_domain']%>:5000/<%= node['bcpc']['catalog']['identity']['uris']['internal'] %>/
identity_uri = <%=node['bcpc']['protocol']['keystone']%>://openstack.<%=node['bcpc']['cluster_domain']%>:35357
auth_version = <%= node['bcpc']['catalog']['identity']['uris']['internal'] %>
admin_tenant_name = <%=node['bcpc']['admin_tenant']%>
admin_user = <%=get_config('keystone-admin-user')%>
admin_password = <%=get_config('keystone-admin-password')%>
signing_dir = /var/lib/cinder

<% node['bcpc']['ceph']['enabled_pools'].each do |type| -%>
[<%= type.upcase %>]
volume_driver=cinder.volume.drivers.rbd.RBDDriver
volume_backend_name=<%= type.upcase %>
rbd_user=cinder
rbd_pool=<%="#{node['bcpc']['ceph']['volumes']['name']}-#{type}"%>
rbd_secret_uuid=<%=get_config('libvirt-secret-uuid')%>
rbd_flatten_volume_from_snapshot=<%= node['bcpc']['cinder']['rbd_flatten_volume_from_snapshot'] %>
rbd_max_clone_depth=<%= node['bcpc']['cinder']['rbd_max_clone_depth'] %>
rbd_store_chunk_size = 4
rados_connect_timeout = -1
glance_api_version = 2
<% end -%>
